!function(l,s){"use strict";function t(e,t){this.selectedRange=null,this.editor=s(e);var n=s(e),o={hotKeys:{"Ctrl+b meta+b":"bold","Ctrl+i meta+i":"italic","Ctrl+u meta+u":"underline","Ctrl+z":"undo","Ctrl+y meta+y meta+shift+z":"redo","Ctrl+l meta+l":"justifyleft","Ctrl+r meta+r":"justifyright","Ctrl+e meta+e":"justifycenter","Ctrl+j meta+j":"justifyfull","Shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,keypressTimeout:200,fileUploadError:function(e,t){console.log("File upload error",e,t)}},a=s.extend(!0,{},o,t),i="a[data-"+a.commandRole+"],button[data-"+a.commandRole+"],input[type=button][data-"+a.commandRole+"]";this.bindHotkeys(n,a,i),a.dragAndDropImages&&this.initFileDrops(n,a,i),this.bindToolbar(n,s(a.toolbarSelector),a,i),n.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){this.saveSelection(),this.updateToolbar(n,i,a)}.bind(this));var r=this;s(l).bind("touchend",function(e){var t=n.is(e.target)||0<n.has(e.target).length,o=r.getCurrentRange();o&&o.startContainer===o.endContainer&&o.startOffset===o.endOffset&&!t||(r.saveSelection(),r.updateToolbar(n,i,a))})}t.prototype.readFileIntoDataUrl=function(e){var t=s.Deferred(),o=new FileReader;return o.onload=function(e){t.resolve(e.target.result)},o.onerror=t.reject,o.onprogress=t.notify,o.readAsDataURL(e),t.promise()},t.prototype.cleanHtml=function(e){var t,o,n,a,i=this;!0===s(i).data("wysiwyg-html-mode")&&(s(i).html(s(i).text()),s(i).attr("contenteditable",!0),s(i).data("wysiwyg-html-mode",!1)),!0===e&&s(i).parent().is("form")&&(t=s(i).html,s(t).has("img").length&&(o=s("img",s(t)),n=[],a=s(i).parent(),s.each(o,function(e,t){s(t).attr("src").match(/^data:image\/.*$/)&&(n.push(o[e]),s(a).prepend("<input value='"+s(t).attr("src")+"' type='hidden' name='postedimage/"+e+"' />"),s(t).attr("src","postedimage/"+e))})));var r=s(i).html();return r&&r.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")},t.prototype.updateToolbar=function(e,t,n){n.activeToolbarClass&&s(n.toolbarSelector).find(t).each(function(){var e=s(this),t=e.data(n.commandRole).split(" "),o=t[0];1<t.length&&document.queryCommandEnabled(o)&&document.queryCommandValue(o)===t[1]||1===t.length&&document.queryCommandEnabled(o)&&document.queryCommandState(o)?e.addClass(n.activeToolbarClass):e.removeClass(n.activeToolbarClass)})},t.prototype.execCommand=function(e,t,o,n,a){var i=e.split(" "),r=i.shift(),l=i.join(" ")+(t||""),s=e.split("-");1===s.length?document.execCommand(r,!1,l):"format"===s[0]&&2===s.length&&document.execCommand("formatBlock",!1,s[1]),o.trigger("change"),this.updateToolbar(o,a,n)},t.prototype.bindHotkeys=function(o,n,a){var i=this;s.each(n.hotKeys,function(e,t){t&&s(o).keydown(e,function(e){o.attr("contenteditable")&&s(o).is(":visible")&&(e.preventDefault(),e.stopPropagation(),i.execCommand(t,null,o,n,a))}).keyup(e,function(e){o.attr("contenteditable")&&s(o).is(":visible")&&(e.preventDefault(),e.stopPropagation())})}),o.keyup(function(){o.trigger("change")})},t.prototype.getCurrentRange=function(){var e,t;return l.getSelection?(e=l.getSelection()).getRangeAt&&e.rangeCount&&(t=e.getRangeAt(0)):document.selection&&(t=document.selection.createRange()),t},t.prototype.saveSelection=function(){this.selectedRange=this.getCurrentRange()},t.prototype.restoreSelection=function(){var e;if(l.getSelection||document.createRange){if(e=l.getSelection(),this.selectedRange){try{e.removeAllRanges()}catch(e){document.body.createTextRange().select(),document.selection.empty()}e.addRange(this.selectedRange)}}else document.selection&&this.selectedRange&&this.selectedRange.select()},t.prototype.toggleHtmlEdit=function(e){var t,o;!0!==e.data("wysiwyg-html-mode")?(t=e.html(),o=s("<pre />"),s(o).append(document.createTextNode(t)),s(o).attr("contenteditable",!0),s(e).html(" "),s(e).append(s(o)),s(e).attr("contenteditable",!1),s(e).data("wysiwyg-html-mode",!0),s(o).focus()):(s(e).html(s(e).text()),s(e).attr("contenteditable",!0),s(e).data("wysiwyg-html-mode",!1),s(e).focus())},t.prototype.insertFiles=function(e,o,n,a){var i=this;n.focus(),s.each(e,function(e,t){/^image\//.test(t.type)?s.when(i.readFileIntoDataUrl(t)).done(function(e){i.execCommand("insertimage",e,n,o,a),n.trigger("image-inserted")}).fail(function(e){o.fileUploadError("file-reader",e)}):o.fileUploadError("unsupported-file-type",t.type)})},t.prototype.markSelection=function(e,t,o){this.restoreSelection(),document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",!1,t||"transparent"),this.saveSelection(),e.data(o.selectionMarker,t)},t.prototype.bindToolbar=function(t,e,o,n){var a=this;e.find(n).click(function(){a.restoreSelection(),t.focus(),"html"===t.data(o.commandRole)?a.toggleHtmlEdit(t):a.execCommand(s(this).data(o.commandRole),null,t,o,n),a.saveSelection()}),e.find("[data-toggle=dropdown]").click(this.restoreSelection()),e.find("input[type=text][data-"+o.commandRole+"]").on("webkitspeechchange change",function(){var e=this.value;this.value="",a.restoreSelection(),e&&(t.focus(),a.execCommand(s(this).data(o.commandRole),e,t,o,n)),a.saveSelection()}).on("focus",function(){var e=s(this);e.data(o.selectionMarker)||(a.markSelection(e,o.selectionColor,o),e.focus())}).on("blur",function(){var e=s(this);e.data(o.selectionMarker)&&a.markSelection(e,!1,o)}),e.find("input[type=file][data-"+o.commandRole+"]").change(function(){a.restoreSelection(),"file"===this.type&&this.files&&0<this.files.length&&a.insertFiles(this.files,o,t,n),a.saveSelection(),this.value=""})},t.prototype.initFileDrops=function(o,n,a){var i=this;o.on("dragenter dragover",!1).on("drop",function(e){var t=e.originalEvent.dataTransfer;e.stopPropagation(),e.preventDefault(),t&&t.files&&0<t.files.length&&i.insertFiles(t.files,n,o,a)})},s.fn.wysiwyg=function(e){new t(this,e)}}(window,window.jQuery);